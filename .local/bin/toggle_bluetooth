#!/usr/bin/env python3

import subprocess, time

try:
    result = subprocess.run(['bluetoothctl', 'show'], capture_output=True, text=True, check=True)
    is_bluetooth_active = "Powered: yes" in result.stdout
    
except subprocess.CalledProcessError:
    is_bluetooth_active = False

if is_bluetooth_active:
    subprocess.run('playerctl pause'.split())
    subprocess.run('bluetoothctl power off'.split())
    subprocess.run('rfkill block bluetooth'.split())

else:
    subprocess.run('rfkill unblock bluetooth'.split())
    time.sleep(1)
    subprocess.run('bluetoothctl power on'.split())
    
    result = subprocess.run(['bluetoothctl', 'devices', 'Paired'], stdout=subprocess.PIPE, text=True)
    filtered_output = subprocess.run(['grep', 'Device'], input=result.stdout, stdout=subprocess.PIPE, text=True) 

    last_device = filtered_output.stdout.strip().split('\n')[-1]
    device_mac = last_device.split()[1]
    subprocess.run(['bluetoothctl', 'connect', device_mac])
